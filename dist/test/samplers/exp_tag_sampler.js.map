{"version":3,"sources":["../../../test/samplers/exp_tag_sampler.js"],"names":["opentracing","TagEqualsSampler","require","experimental","describe","tagSampler","tagValue","firehose","reporter","InMemoryReporter","tracer","Tracer","it","span","startSpan","tags","theWho","assert","isFalse","_spanContext","isSampled","samplingFinalized","setOperationName","isTrue","who","forEach","t","String","setTag","equal","isFirehose","span2","childOf","context"],"mappings":"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","file":"exp_tag_sampler.js","sourcesContent":["// @flow\n// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n// in compliance with the License. You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software distributed under the License\n// is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n// or implied. See the License for the specific language governing permissions and limitations under\n// the License.\n\nimport { assert } from 'chai';\nimport sinon from 'sinon';\nimport * as opentracing from 'opentracing';\nimport { Span, Tracer, InMemoryReporter } from '../../src/index';\nimport Utils from '../../src/util';\n\nvar TagEqualsSampler = require('../../src/index').experimental.TagEqualsSampler;\n\ndescribe('TagSampler', () => {\n  const tagSampler = new TagEqualsSampler('theWho', [\n    { tagValue: 'Bender', firehose: false },\n    { tagValue: 'Leela', firehose: true },\n  ]);\n  const reporter = new InMemoryReporter();\n  const tracer = new Tracer('test-service-name', reporter, tagSampler);\n\n  it('should not sample or finalize new span without tags and after setOperation', () => {\n    let span = tracer.startSpan('opName', { tags: { theWho: 'Fry' } }); // wrong tag value\n    assert.isFalse(span._spanContext.isSampled(), 'sampled');\n    assert.isFalse(span._spanContext.samplingFinalized, 'finalized');\n    span.setOperationName('opName2');\n    assert.isFalse(span._spanContext.isSampled(), 'sampled');\n    assert.isFalse(span._spanContext.samplingFinalized, 'finalized');\n  });\n\n  it('should sample and finalize created span with tag', () => {\n    let span = tracer.startSpan('opName', { tags: { theWho: 'Bender' } });\n    assert.isTrue(span._spanContext.isSampled(), 'sampled');\n    assert.isTrue(span._spanContext.samplingFinalized, 'finalized');\n  });\n\n  [{ who: 'Bender', firehose: false }, { who: 'Leela', firehose: true }].forEach(t => {\n    // have to coerce t.firehose to string, because flow complains about it otherwise.\n    it(`should sample and finalize span after setTag \"${t.who}\" and set firehose=${String(\n      t.firehose\n    )}`, () => {\n      let span = tracer.startSpan('opName');\n      assert.isFalse(span._spanContext.isSampled(), 'sampled');\n      assert.isFalse(span._spanContext.samplingFinalized, 'finalized');\n      span.setTag('theTag', 'Fry'); // wrong tag key\n      span.setTag('theWho', 'Fry'); // wrong tag value\n      assert.isFalse(span._spanContext.isSampled(), 'sampled');\n      assert.isFalse(span._spanContext.samplingFinalized, 'finalized');\n      span.setTag('theWho', t.who);\n      assert.isTrue(span._spanContext.isSampled(), 'sampled');\n      assert.isTrue(span._spanContext.samplingFinalized, 'finalized');\n      assert.equal(t.firehose, span._spanContext.isFirehose(), 'finalized');\n    });\n  });\n\n  it('should not sample or finalize span after starting a child span', () => {\n    let span = tracer.startSpan('opName');\n    let span2 = tracer.startSpan('opName2', { childOf: span.context() });\n    assert.isFalse(span._spanContext.isSampled(), 'sampled');\n    assert.isFalse(span._spanContext.samplingFinalized, 'finalized');\n  });\n});\n"]}