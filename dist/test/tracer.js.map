{"version":3,"sources":["../../test/tracer.js"],"names":["constants","opentracing","describe","tracer","reporter","InMemoryReporter","beforeEach","Tracer","ConstSampler","afterEach","clear","close","it","ck","mytracer","contextKey","headers","mycontext","extract","FORMAT_HTTP_HEADERS","assert","equal","toString","myspan","startSpan","childOf","context","traceIdStr","exheaders","inject","notEqual","_tags","PROCESS_IP","Utils","myIp","TRACER_HOSTNAME_TAG_KEY","os","hostname","mytags","tags","TRACER_BAGGAGE_HEADER_PREFIX","JAEGER_BAGGAGE_HEADER","spanContext","FORMAT_TEXT_MAP","rootSpan","isNotNull","traceId","isDefined","isNull","parentId","flags","getBaggageItem","encodeInt64","spanId","SpanContext","withBinaryIds","start","rpcServer","keyOne","keyTwo","internalTags","references","span","_startInternalSpan","deepEqual","_startTime","isTrue","JaegerTestUtils","hasTags","_report","spans","length","actualTags","_","sortBy","o","key","value","startTime","Date","getTime","isSampled","nextId","getId","parentContext","childOfContext","childOfRef","Reference","REFERENCE_CHILD_OF","followsFromContext","followsFromRef","REFERENCE_FOLLOWS_FROM","testCases","message","spanOptions","verify","forEach","params","finish","Object","create","baggage","savedContext","SAMPLED_MASK","assertByFormat","carrier","format","extractedContext","Buffer","concat","to","throw","throttler","DefaultThrottler","setProcess","sinon","spy","debugThrottler","_process","serviceName","isString","uuid","calledWith","calledOnce","sampled","metrics","each","Metrics","LocalMetricFactory","fromString","Tags","SPAN_KIND","SPAN_KIND_RPC_SERVER","LocalBackend","counterEquals","metricName","spansFinished","traceId128bit","slice","parent","child","substring","robot","customReporter","customTracer","shareRpcSpan","_spanContext"],"mappings":"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","file":"tracer.js","sourcesContent":["// Copyright (c) 2016 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n// in compliance with the License. You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software distributed under the License\n// is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n// or implied. See the License for the specific language governing permissions and limitations under\n// the License.\n\nimport _ from 'lodash';\nimport { assert, expect } from 'chai';\nimport ConstSampler from '../src/samplers/const_sampler';\nimport * as constants from '../src/constants';\nimport InMemoryReporter from '../src/reporters/in_memory_reporter';\nimport * as opentracing from 'opentracing';\nimport SpanContext from '../src/span_context';\nimport Tracer from '../src/tracer';\nimport Utils from '../src/util';\nimport Metrics from '../src/metrics/metrics';\nimport LocalMetricFactory from './lib/metrics/local/metric_factory';\nimport LocalBackend from './lib/metrics/local/backend';\nimport sinon from 'sinon';\nimport DefaultThrottler from '../src/throttler/default_throttler';\nimport os from 'os';\nimport JaegerTestUtils from '../src/test_util';\n\ndescribe('tracer should', () => {\n  let tracer;\n  let reporter = new InMemoryReporter();\n\n  beforeEach(() => {\n    tracer = new Tracer('test-service-name', reporter, new ConstSampler(true));\n  });\n\n  afterEach(() => {\n    reporter.clear();\n    tracer.close();\n  });\n\n  it('be able to override codec contextKey and extract context', () => {\n    let ck = 'test-trace-id';\n    let mytracer = new Tracer('test-service-name', reporter, new ConstSampler(true), {\n      contextKey: ck,\n    });\n\n    let headers = {\n      'test-trace-id': 'a:b:c:d',\n    };\n\n    let mycontext = mytracer.extract(opentracing.FORMAT_HTTP_HEADERS, headers);\n    assert.equal(mycontext.toString(), headers[ck]);\n\n    let myspan = mytracer.startSpan('myspan', { childOf: mycontext });\n    assert.equal(myspan.context().traceIdStr, 'a');\n\n    let exheaders = {};\n\n    mytracer.inject(myspan.context(), opentracing.FORMAT_HTTP_HEADERS, exheaders);\n    assert.notEqual(exheaders[ck], null);\n  });\n\n  it('find the ip and hostname by default', () => {\n    assert.equal(tracer._tags[constants.PROCESS_IP], Utils.myIp());\n    assert.equal(tracer._tags[constants.TRACER_HOSTNAME_TAG_KEY], os.hostname());\n  });\n\n  it('be able to override ip and hostname tags if provided', () => {\n    let mytags = {};\n    mytags[constants.PROCESS_IP] = '10.0.0.1';\n    mytags[constants.TRACER_HOSTNAME_TAG_KEY] = '10.0.0.1.internal';\n    let mytracer = new Tracer('test-service-name', reporter, new ConstSampler(true), {\n      tags: mytags,\n    });\n\n    assert.equal(mytracer._tags[constants.PROCESS_IP], '10.0.0.1');\n    assert.equal(mytracer._tags[constants.TRACER_HOSTNAME_TAG_KEY], '10.0.0.1.internal');\n  });\n\n  it('begin a new span given only baggage headers', () => {\n    // Users sometimes want to pass baggage even if there is no span.\n    // In this case we must ensure a new root span is created.\n    let headers = {};\n    // combine normal baggage encoding\n    headers[constants.TRACER_BAGGAGE_HEADER_PREFIX + 'robot'] = 'Bender';\n    // with custom encoding via `jaeger-baggage` header\n    headers[constants.JAEGER_BAGGAGE_HEADER] = 'male=Fry, female=Leela, Lord Nibbler';\n    let spanContext = tracer.extract(opentracing.FORMAT_TEXT_MAP, headers);\n    let rootSpan = tracer.startSpan('fry', { childOf: spanContext });\n\n    assert.isNotNull(rootSpan.context().traceId);\n    assert.isDefined(rootSpan.context().traceId);\n    assert.isNull(rootSpan.context().parentId);\n    assert.equal(rootSpan.context().flags, 1);\n    assert.equal('Bender', rootSpan.getBaggageItem('robot'));\n    assert.equal('Leela', rootSpan.getBaggageItem('female'));\n    assert.equal('Fry', rootSpan.getBaggageItem('male'));\n  });\n\n  it('create a span correctly through _startInternalSpan', () => {\n    let traceId = Utils.encodeInt64(1);\n    let spanId = Utils.encodeInt64(2);\n    let parentId = Utils.encodeInt64(3);\n    let flags = 1;\n    let context = SpanContext.withBinaryIds(traceId, spanId, parentId, flags);\n    let start = 123.456;\n    let rpcServer = false;\n    let tags = {\n      keyOne: 'Leela',\n      keyTwo: 'Bender',\n    };\n    let internalTags = {\n      'internal-tag': 'Fry',\n    };\n    let references = [];\n    let span = tracer._startInternalSpan(\n      context,\n      'op-name',\n      start,\n      tags,\n      internalTags,\n      references,\n      false,\n      rpcServer\n    );\n\n    assert.deepEqual(span.context().traceId, traceId);\n    assert.deepEqual(span.context().spanId, spanId);\n    assert.deepEqual(span.context().parentId, parentId);\n    assert.equal(span.context().flags, flags);\n    assert.equal(span._startTime, start);\n    assert.isTrue(\n      JaegerTestUtils.hasTags(span, {\n        keyOne: 'Leela',\n        keyTwo: 'Bender',\n        'sampler.type': 'const',\n        'sampler.param': true,\n        'internal-tag': 'Fry',\n      })\n    );\n  });\n\n  it('report a span with no tracer level tags', () => {\n    let span = tracer.startSpan('op-name');\n    tracer._report(span);\n    assert.equal(1, reporter.spans.length);\n    let actualTags = _.sortBy(span._tags, o => {\n      return o.key;\n    });\n\n    assert.equal(2, actualTags.length);\n    assert.equal(actualTags[0].key, 'sampler.param');\n    assert.equal(actualTags[1].key, 'sampler.type');\n    assert.equal(actualTags[0].value, true);\n    assert.equal(actualTags[1].value, 'const');\n  });\n\n  it('start a root span with proper structure', () => {\n    let startTime = new Date(2016, 8, 18).getTime();\n    let span = tracer.startSpan('test-name', {\n      startTime: startTime,\n    });\n\n    assert.equal(span.context().traceId, span.context().spanId);\n    assert.equal(span.context().parentId, null);\n    assert.isTrue(span.context().isSampled());\n    assert.equal(span._startTime, startTime);\n  });\n\n  describe('start a child span represented as a separate span from parent, using childOf and references', () => {\n    let nextId = 0;\n    const getId = () => Utils.encodeInt64(nextId++);\n    const traceId = getId();\n    const flags = 1;\n\n    const parentContext = SpanContext.withBinaryIds(traceId, getId(), null, flags);\n    const childOfContext = SpanContext.withBinaryIds(traceId, getId(), null, flags);\n    const childOfRef = new opentracing.Reference(opentracing.REFERENCE_CHILD_OF, childOfContext);\n    const followsFromContext = SpanContext.withBinaryIds(traceId, getId(), null, flags);\n    const followsFromRef = new opentracing.Reference(opentracing.REFERENCE_FOLLOWS_FROM, followsFromContext);\n\n    const testCases = [\n      {\n        message: 'starts a span based on childOf',\n        spanOptions: {\n          childOf: parentContext,\n          references: [],\n        },\n        verify: parentContext,\n      },\n      {\n        message: 'starts a span based on childOf, ignoring FOLLOWS_FROM',\n        spanOptions: {\n          childOf: parentContext,\n          references: [followsFromRef],\n        },\n        verify: parentContext,\n      },\n      {\n        message: 'starts a span based on childOf, ignoring CHILD_OF and FOLLOWS_FROM',\n        spanOptions: {\n          childOf: parentContext,\n          references: [childOfRef, followsFromRef],\n        },\n        verify: parentContext,\n      },\n      {\n        message: 'starts a span with parent falling back to the CHILD_OF ref',\n        spanOptions: {\n          childOf: null,\n          references: [childOfRef],\n        },\n        verify: childOfContext,\n      },\n      {\n        message: 'starts a span with parent falling back to the FOLLOWS_FROM ref',\n        spanOptions: {\n          childOf: null,\n          references: [followsFromRef],\n        },\n        verify: followsFromContext,\n      },\n      {\n        message: 'starts a span with parent falling back to the CHILD_OF ref and ignoring FOLLOWS_FROM',\n        spanOptions: {\n          childOf: null,\n          references: [childOfRef, followsFromRef],\n        },\n        verify: childOfContext,\n      },\n    ];\n\n    testCases.forEach(params => {\n      const { message, spanOptions, verify } = params;\n      it(message, () => {\n        let span = tracer.startSpan('bender', {\n          childOf: spanOptions.childOf,\n          references: spanOptions.references,\n        });\n        span.finish();\n        assert.deepEqual(span.context().traceId, verify.traceId);\n        assert.deepEqual(span.context().parentId, verify.spanId);\n      });\n    });\n  });\n\n  it('inject and extract headers from carriers without Object prototypes', () => {\n    let ck = 'test-trace-id';\n    let mytracer = new Tracer('test-service-name', reporter, new ConstSampler(true), {\n      contextKey: ck,\n    });\n\n    let headers = Object.create(null);\n    headers[ck] = 'a:b:c:d';\n\n    let mycontext = mytracer.extract(opentracing.FORMAT_HTTP_HEADERS, headers);\n    assert.equal(mycontext.toString(), headers[ck]);\n\n    let myspan = mytracer.startSpan('myspan', { childOf: mycontext });\n    assert.equal(myspan.context().traceIdStr, 'a');\n\n    let exheaders = Object.create(null);\n\n    mytracer.inject(myspan.context(), opentracing.FORMAT_HTTP_HEADERS, exheaders);\n    assert.notEqual(exheaders[ck], null);\n  });\n\n  it('inject plain text headers into carrier, and extract span context with the same value', () => {\n    let keyOne = 'keyOne';\n    let keyTwo = 'keyTwo';\n    let baggage = {\n      keyOne: 'leela',\n      keyTwo: 'bender',\n    };\n    let savedContext = SpanContext.withBinaryIds(\n      Utils.encodeInt64(1),\n      Utils.encodeInt64(2),\n      Utils.encodeInt64(3),\n      constants.SAMPLED_MASK,\n      baggage\n    );\n\n    let assertByFormat = format => {\n      let carrier = {};\n      tracer.inject(savedContext, format, carrier);\n      let extractedContext = tracer.extract(format, carrier);\n\n      assert.deepEqual(savedContext.traceId, extractedContext.traceId);\n      assert.deepEqual(savedContext.spanId, extractedContext.spanId);\n      assert.deepEqual(savedContext.parentId, extractedContext.parentId);\n      assert.equal(savedContext.flags, extractedContext.flags);\n      assert.equal(savedContext.baggage[keyOne], extractedContext.baggage[keyOne]);\n      assert.equal(savedContext.baggage[keyTwo], extractedContext.baggage[keyTwo]);\n    };\n\n    assertByFormat(opentracing.FORMAT_TEXT_MAP);\n    assertByFormat(opentracing.FORMAT_HTTP_HEADERS);\n  });\n\n  it('inject plain text headers into carrier, and extract span context with the same value 128bits', () => {\n    let keyOne = 'keyOne';\n    let keyTwo = 'keyTwo';\n    let baggage = {\n      keyOne: 'leela',\n      keyTwo: 'bender',\n    };\n    let savedContext = SpanContext.withBinaryIds(\n      Buffer.concat([Utils.encodeInt64(1), Utils.encodeInt64(2)]),\n      Utils.encodeInt64(2),\n      Utils.encodeInt64(3),\n      constants.SAMPLED_MASK,\n      baggage\n    );\n\n    let assertByFormat = format => {\n      let carrier = {};\n      tracer.inject(savedContext, format, carrier);\n      let extractedContext = tracer.extract(format, carrier);\n\n      assert.deepEqual(savedContext.traceId, extractedContext.traceId);\n      assert.deepEqual(savedContext.spanId, extractedContext.spanId);\n      assert.deepEqual(savedContext.parentId, extractedContext.parentId);\n      assert.equal(savedContext.flags, extractedContext.flags);\n      assert.equal(savedContext.baggage[keyOne], extractedContext.baggage[keyOne]);\n      assert.equal(savedContext.baggage[keyTwo], extractedContext.baggage[keyTwo]);\n    };\n\n    assertByFormat(opentracing.FORMAT_TEXT_MAP);\n    assertByFormat(opentracing.FORMAT_HTTP_HEADERS);\n  });\n\n  it('inject url encoded values into headers', () => {\n    let baggage = {\n      keyOne: 'Leela vs. Bender',\n    };\n    let savedContext = SpanContext.withBinaryIds(\n      Utils.encodeInt64(1),\n      Utils.encodeInt64(2),\n      Utils.encodeInt64(3),\n      constants.SAMPLED_MASK,\n      baggage\n    );\n    let carrier = {};\n\n    tracer.inject(savedContext, opentracing.FORMAT_HTTP_HEADERS, carrier);\n    assert.equal(carrier['uberctx-keyOne'], 'Leela%20vs.%20Bender');\n  });\n\n  it('assert inject and extract throw errors when given an invalid format', () => {\n    let carrier = {};\n    let context = SpanContext.withBinaryIds(\n      Utils.encodeInt64(1),\n      Utils.encodeInt64(2),\n      Utils.encodeInt64(3),\n      constants.SAMPLED_MASK\n    );\n\n    // subtle but expect wants a function to call not the result of a function call.\n    expect(() => {\n      tracer.inject(context, 'fake-format', carrier);\n    }).to.throw('Unsupported format: fake-format');\n    expect(() => {\n      tracer.extract('fake-format', carrier);\n    }).to.throw('Unsupported format: fake-format');\n  });\n\n  it('report spans', () => {\n    let span = tracer.startSpan('operation');\n    tracer._report(span);\n\n    assert.equal(reporter.spans.length, 1);\n  });\n\n  it('set _process on initialization', () => {\n    const throttler = new DefaultThrottler();\n    throttler.setProcess = sinon.spy();\n    tracer = new Tracer('x', reporter, new ConstSampler(true), {\n      debugThrottler: throttler,\n    });\n    assert.equal(tracer._process.serviceName, 'x');\n    assert.isString(tracer._process.uuid);\n    sinon.assert.calledWith(throttler.setProcess, tracer._process);\n  });\n\n  it('close _debugThrottler on close', () => {\n    const throttler = new DefaultThrottler();\n    throttler.close = sinon.spy();\n    tracer = new Tracer('x', reporter, new ConstSampler(true), {\n      debugThrottler: throttler,\n    });\n    tracer.close();\n    sinon.assert.calledOnce(throttler.close);\n  });\n\n  describe('Metrics', () => {\n    it('startSpan', () => {\n      let params = [\n        {\n          rpcServer: false,\n          context: null,\n          sampled: true,\n          metrics: ['spansStartedSampled', 'tracesStartedSampled'],\n        },\n        {\n          rpcServer: true,\n          context: '1:2:100:1',\n          sampled: true,\n          metrics: ['spansStartedSampled', 'tracesJoinedSampled'],\n        },\n        {\n          rpcServer: false,\n          context: null,\n          sampled: false,\n          metrics: ['spansStartedNotSampled', 'tracesStartedNotSampled'],\n        },\n        {\n          rpcServer: true,\n          context: '1:2:100:0',\n          sampled: false,\n          metrics: ['spansStartedNotSampled', 'tracesJoinedNotSampled'],\n        },\n      ];\n\n      _.each(params, o => {\n        let metrics = new Metrics(new LocalMetricFactory());\n        tracer = new Tracer('fry', new InMemoryReporter(), new ConstSampler(o.sampled), {\n          metrics: metrics,\n        });\n\n        let context = null;\n        if (o.context) {\n          context = SpanContext.fromString(o.context);\n        }\n\n        let tags = {};\n        if (o.rpcServer) {\n          tags[opentracing.Tags.SPAN_KIND] = opentracing.Tags.SPAN_KIND_RPC_SERVER;\n        }\n\n        tracer.startSpan('bender', {\n          childOf: context,\n          tags: tags,\n        });\n\n        _.each(o.metrics, metricName => {\n          assert.isTrue(LocalBackend.counterEquals(metrics[metricName], 1));\n        });\n      });\n    });\n\n    it('emits counter when report called', () => {\n      let metrics = new Metrics(new LocalMetricFactory());\n      tracer = new Tracer('fry', new InMemoryReporter(), new ConstSampler(true), {\n        metrics: metrics,\n      });\n      let span = tracer.startSpan('bender');\n      tracer._report(span);\n\n      assert.isTrue(LocalBackend.counterEquals(metrics.spansFinished, 1));\n    });\n  });\n\n  it('start a root span with 128 bit traceId', () => {\n    tracer = new Tracer('test-service-name', reporter, new ConstSampler(true), { traceId128bit: true });\n    let span = tracer.startSpan('test-name');\n\n    assert.deepEqual(span.context().traceId.slice(-8), span.context().spanId);\n    assert.equal(16, span.context().traceId.length);\n  });\n\n  it('preserve 64bit traceId even when in 128bit mode', () => {\n    // NB: because we currently trim leading zeros, this test is not as effective as it could be.\n    // But once https://github.com/jaegertracing/jaeger-client-node/issues/391 is fixed, this test\n    // will be more useful as it can catch regression.\n    tracer = new Tracer('test-service-name', reporter, new ConstSampler(true), { traceId128bit: true });\n    let span = tracer.startSpan('test-name');\n    assert.equal(16, span.context().traceId.length, 'new traces use 128bit IDs');\n\n    let parent = SpanContext.fromString('100:7f:0:1');\n    assert.equal(8, parent.traceId.length, 'respect 64bit length');\n\n    let child = tracer.startSpan('test-name', { childOf: parent });\n    assert.equal(8, child.context().traceId.length, 'preserve 64bit length');\n\n    let carrier = {};\n    tracer.inject(child.context(), opentracing.FORMAT_TEXT_MAP, carrier);\n    // Once https://github.com/jaegertracing/jaeger-client-node/issues/391 is fixed, the following\n    // asset will fail and will need to be changed to compare against '0000000000000100' string.\n    assert.equal('100:', carrier['uber-trace-id'].substring(0, 4), 'preserve 64bit length');\n  });\n\n  it('should NOT mutate tags', () => {\n    const tags = {\n      robot: 'bender',\n    };\n    tracer = new Tracer('test-service-name', reporter, new ConstSampler(true), {\n      tags: tags,\n    });\n    tracer.close();\n    assert.notEqual(tags, tracer._tags);\n    assert.deepEqual(tags, {\n      robot: 'bender',\n    });\n  });\n});\n\nit('should match parent and spanIds when in rpc server mode', () => {\n  let traceId = Utils.encodeInt64(1);\n  let spanId = Utils.encodeInt64(2);\n  let flags = 1;\n  const parentContext = SpanContext.withBinaryIds(traceId, spanId, null, flags);\n\n  let tags = {};\n  tags[opentracing.Tags.SPAN_KIND] = opentracing.Tags.SPAN_KIND_RPC_SERVER;\n\n  let customReporter = new InMemoryReporter();\n  let customTracer = new Tracer('test-service-name', customReporter, new ConstSampler(true), {\n    shareRpcSpan: true,\n  });\n  let span = customTracer.startSpan('bender', {\n    childOf: parentContext,\n    tags: tags,\n  });\n\n  assert.equal(parentContext.spanId, span._spanContext.spanId);\n  assert.equal(parentContext.parentId, span._spanContext.parentId);\n\n  customReporter.clear();\n  customTracer.close();\n});\n"]}